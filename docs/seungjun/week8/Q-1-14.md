# Q) 14. 컴포저블 함수 내에서 안전하게 코루틴 스코프(coroutine scope)를 생성하는 방법은 무엇인가요?

기본적으로 Compose 에서 코루틴 스코프를 생성하기 위해서는 `rememberCoroutineScope` 를 사용합니다.

### rememberCoroutineScope 사용 이유

`rememberCoroutineScope` 는 컴포저블이 컴포지션을 벗어날 때 활성 중인 코루틴 스코프를 자동으로 취소합니다. 내부적으로 컴포저블 함수의 내부 생명주기를 인지하여 동작하기에 개발자는 수동으로 생명주기를 관리할 필요가 없습니다.

↔ GlobalScope 앱 전역에 사용되는 Scope로 코루틴 스코프를 수동으로 관리해야합니다.

컴포저블이 사라져도 유지되어야하는 경우, viewmodel 의 ViewModelScope 를 사용하거나, lifecycleScope 를 사용해 생명주기 관리를 보장하면서 예기치 않은 작업 취소를 방지할 수 있습니다.

### rememberCoroutineScope 내부 구조

```kotlin
@Composable
public inline fun rememberCoroutineScope(
    crossinline getContext: @DisallowComposableCalls () -> CoroutineContext = {
        EmptyCoroutineContext
    }
): CoroutineScope {
    val composer = currentComposer
    return remember { createCompositionCoroutineScope(getContext(), composer) }
}

@PublishedApi
@OptIn(InternalComposeApi::class)
internal fun createCompositionCoroutineScope(
    coroutineContext: CoroutineContext,
    composer: Composer,
): CoroutineScope =
    if (coroutineContext[Job] != null) {
        CoroutineScope(
            Job().apply {
                completeExceptionally(
                    IllegalArgumentException(
                        "CoroutineContext supplied to " +
                            "rememberCoroutineScope may not include a parent job"
                    )
                )
            }
        )
    } else {
        val applyContext = composer.applyCoroutineContext
        RememberedCoroutineScope(applyContext, coroutineContext)
    }
```

`createCompositionCoroutineScope` 를 통해 주어진 코루틴 컨텍스트에 대해 새 코루틴 스코프를 생성하는 역할을 합니다.

**상위 Job 제한**: 제공된 `CoroutineContext` 에서 Job 을 포함하고 있는 경우 예외가 발생합니다. `rememberCoroutineScope` 가 기존의 상위 Job 에 종속되는 것이 아닌 독립적 스코프를 생성하도록 보장합니다.

**Job 관리**:스코프를 관리하기 위해 Job 이 코루틴 컨텍스트에 추가됩니다.

**Composer 통합**: `composer.applyCoroutineContext` 를 새로 생성된 Job 과 결합해 코루틴 스코프를 설정합니다.

### 실전 질문

Q) 컴포저블 내에서 직접 코루틴 스코프를 생성하고 시작하면 어떤 위험성이 발생할 수 있나요? `rememberCoroutineScope`를 사용해야 하는 이유가 무엇인가요?

`rememberCoroutineScope()`는 **Composable의 Composition 생명주기에 묶인 스코프**를 제공합니다.

같은 Composition 동안은 **스코프가 재사용**되어 리컴포지션마다 새로 만들어지지 않아요. Composable이 Composition에서 제거되면 **자동으로 cancel**되어 누수/백그라운드 작업을 줄입니다.

즉, UI 이벤트(버튼 클릭 등)로 “즉시 실행하는 작업”을 안전하게 launch할 수 있게 해줍니다.